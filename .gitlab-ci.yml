# .gitlab-ci.yml for USGS SAS deployment
#
# Reference:
#   - https://docs.gitlab.com/ee/ci/yaml/
#
# GitLab Group CI Variables:
#   DEPLOY_TRIGGER_REF
#     Set on the individual deployment jobs below. This is the branch name to
#     trigger on the deployment pipeline.
#
#   DEPLOY_TRIGGER_TOKEN
#     The GitLab API token for triggering the deployment pipeline. This is
#     configured on the deployment repository.
#     Specified external to this file as a CI variable.
#
#   DEPLOY_TRIGGER_URL
#     API URL for triggering the deployment pipeline. This is configured on the
#     deployment repository.
#     Specified external to this file as a CI variable.
#
#   ARTIFACTORY_BASE_URL
#     Base URL for SAS Artifactory.
#
#   SAS_IMAGES_URL
#     Base URL for SAS Docker image registry.
#
---
stages:
  - Build
  - Package
  - Deploy Trigger

variables:
  # Full URL to the Artifactory repository
  ARTIFACTORY_URL: ${ARTIFACTORY_BASE_URL}/nbm
#
# Use npm to produce a static site artifact
#
npm_build:
  stage: Build
  # Use an internal registry for node
  # This variable is set in gitlab group vars
  image: ${SAS_IMAGES_URL}/node:10.15
  tags:
    - docker
  script:
    - export PATH=${PWD}/node_modules/.bin:${PATH}
    - npm install
    - npm run build
  artifacts:
    paths:
      - build
      - package-lock.json

#
# Compress and upload the build artifact to artifactory
#
# The ARTIFACTORY_TARGET_FILE is determined by evaluating the
# version from the tag or "latest" for a master build.
# e.g. nbm-2.0.4.zip or nbm-latest.zip
#
#
# == Upload artifact to Artifactory
#
# This job zips the build directory and uploads it to Artifactory. The URL to
# the artifact is passed in the deployment trigger.
#
# NOTE: This uses an ARTIFACTORY_TOKEN, which is specified as a global ci
#       variable under /sas/.
# TODO: Use a project-specific token.
.artifactory_deploy:
  image: code.chs.usgs.gov:5001/sas/ops/ci-pipeline/sas-deploy-tool:latest
  stage: Package
  tags:
    - docker
  only:
    variables:
      - $CI_COMMIT_REF_PROTECTED == "true"
  dependencies:
    - npm_build
  before_script:
    - echo ARTIFACT_FILE=nbm-${BUILD_VERSION}.zip > .vars
    - echo ARTIFACT_URL=${ARTIFACTORY_URL}/${ARTIFACT_FILE} > .vars
    - source .vars
  script:
    # Zip the contents of the 'dist/' directory.
    - '(cd build && zip -9 -r ../${ARTIFACT_FILE} .)'
    # Compute the sha1sum of the .zip file for uploading to artifactory.
    - export SHA1SUM=$(sha1sum ${ARTIFACT_FILE} | cut -d " " -f1)
    - curl --fail -k
      -H "X-JFrog-Art-Api:${ARTIFACTORY_TOKEN}"
      -H "X-Checksum-Sha1:${SHA1SUM}"
      -T ${ARTIFACT_FILE}
      ${ARTIFACT_URL}
  artifacts:
    paths:
      - .vars

upload_artifact_master:
  extends: .artifactory_deploy
  variables:
    BUILD_VERSION: latest
  only:
    refs:
      - ci
      - master

upload_artifact_tag:
  extends: .artifactory_deploy
  variables:
    BUILD_VERSION: ${CI_COMMIT_TAG}
  only:
    refs:
      - tags

#
# == Deployment Triggers
#
# These jobs use 'curl' to make a request to the GitLab API to trigger the
# deployment repository's pipeline. The pipeline trigger is configured on
# the deployment repository under "Settings -> CI/CD -> Pipeline Triggers",
# which provides an API URL and token. Those values are maintained as
# GitLab group variables.
#
# References:
#   - https://docs.gitlab.com/ee/ci/triggers/README.html
#
.deploy_trigger:
  image: code.chs.usgs.gov:5001/sas/ops/docker/base-images/curl:master-latest
  stage: Deploy Trigger
  tags:
    - docker
  only:
    variables:
      - $CI_COMMIT_REF_PROTECTED == "true"
  variables:
    DEPLOY_TRIGGER_VARS: ARTIFACT_URL
  before_script:
    - source .vars
  script:
    # Trigger the deployment pipeline, passing along the Artifactory URL for
    # the artifact.
    - curl -X POST
      -F variables[ARTIFACT_URL]=${ARTIFACT_URL}
      -F token=${DEPLOY_TRIGGER_TOKEN}
      -F ref=${DEPLOY_TRIGGER_REF}
      ${DEPLOY_TRIGGER_URL}

trigger_deploy_development:
  extends: .deploy_trigger
  variables:
    DEPLOY_TRIGGER_REF: artifactory
  dependencies:
    # The '.vars' file with the ARTIFACT_URL is provided by this job.
    - upload_artifact_master
  only:
    refs:
      - ci
      - master

trigger_deploy_staging:
  extends: .deploy_trigger
  variables:
    # run the deploy pipeline for the staging environment, this code is automatically deployed and scanned
    DEPLOY_TRIGGER_REF: release
  dependencies:
    # The '.vars' file with the ARTIFACT_URL is provided by this job.
    - upload_artifact_tag
  only:
    refs:
      - tags
